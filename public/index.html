<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>𝙄𝙆𝙐𝙉导航站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- NEW: Import SortableJS for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* ... existing styles ... */
        .sortable-ghost { opacity: 0.4; background: #4a5568; }
        .sortable-chosen { background: #2d3748; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- ... existing HTML structure ... -->

    <!-- Admin Panel > Category Management: Modified for reordering -->
    <div id="admin-panel-view" class="hidden ...">
        <!-- ... other admin sections ... -->
        <div class="bg-gray-900 p-6 rounded-lg mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold" data-i18n-key="categoryManagement">Category Management</h3>
                <!-- NEW: Save Order Button -->
                <button id="save-order-btn" class="bg-purple-600 hover:bg-purple-700 rounded-md py-1 px-3 text-sm font-semibold hidden">
                    <span data-i18n-key="saveOrder">Save Order</span>
                </button>
            </div>
            <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                <!-- ... existing form ... -->
            </form>
            <div id="categories-list" class="space-y-2">
                <!-- Draggable category list will be rendered here -->
            </div>
        </div>
        <!-- ... other admin sections ... -->
    </div>
    
    <!-- ... other HTML ... -->

    <script type="module">
        // --- i18n Translations (Add new keys) ---
        const translations = {
            en: { /* ... existing keys ... */ saveOrder: "Save Order", orderSaved: "Order saved successfully!" },
            zh: { /* ... existing keys ... */ saveOrder: "保存顺序", orderSaved: "顺序已保存！" }
        };

        // --- Global State ---
        let sortableInstance = null;

        // --- DOM Elements Cache (Add new button) ---
        const DOMElements = {
            // ... existing elements ...
            saveOrderBtn: document.getElementById('save-order-btn')
        };

        // --- Rendering Functions ---

        // NEW or MODIFIED functions
        function renderAdminPanel() {
            if (!state.isLoggedIn) return;
            
            DOMElements.categoriesList.innerHTML = '';
            // Separate categories by type for individual sorting
            const sidebarCats = state.categories.filter(c => c.type === 'sidebar');
            const topbarCats = state.categories.filter(c => c.type === 'topbar');

            const createSortableList = (titleKey, cats) => {
                if (cats.length === 0) return;
                
                const title = document.createElement('h4');
                title.className = "text-sm font-bold mt-4 mb-2 text-gray-400";
                title.textContent = translations[state.currentLanguage][titleKey];
                DOMElements.categoriesList.appendChild(title);

                const listContainer = document.createElement('div');
                listContainer.id = `sortable-${titleKey}`;
                listContainer.className = "space-y-2";
                DOMElements.categoriesList.appendChild(listContainer);

                cats.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-md';
                    div.dataset.id = cat.id; // Required for SortableJS
                    div.innerHTML = `
                        <div class="flex items-center">
                            <i data-lucide="grip-vertical" class="drag-handle mr-2 text-gray-500"></i>
                            <span>${cat.name}</span>
                        </div>
                        <button data-id="${cat.id}" class="delete-category-btn p-1 text-red-500 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    `;
                    listContainer.appendChild(div);
                });

                // Init SortableJS on the container
                new Sortable(listContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    handle: '.drag-handle',
                    onUpdate: () => DOMElements.saveOrderBtn.classList.remove('hidden')
                });
            };

            createSortableList('sidebar', sidebarCats);
            createSortableList('topbar', topbarCats);
            
            // ... rest of renderAdminPanel ...
            lucide.createIcons();
        }

        // --- Event Listeners (Add new listener) ---
        function setupEventListeners() {
            // ... existing listeners ...
            DOMElements.saveOrderBtn.onclick = async () => {
                const sidebarList = document.getElementById('sortable-sidebar');
                const topbarList = document.getElementById('sortable-topbar');

                const sidebarIds = sidebarList ? Array.from(sidebarList.children).map(el => el.dataset.id) : [];
                const topbarIds = topbarList ? Array.from(topbarList.children).map(el => el.dataset.id) : [];
                
                const orderedIds = [...sidebarIds, ...topbarIds];

                try {
                    await api.post('categories/order', { orderedIds });
                    customAlert('orderSaved');
                    DOMElements.saveOrderBtn.classList.add('hidden');
                    await loadInitialData(); // Reload to reflect new order everywhere
                } catch (err) {
                    console.error("Failed to save order:", err);
                    customAlert("Failed to save order.", false);
                }
            };
        }

        // --- Application Initialization ---
        async function init() {
            // ... existing init logic ...
            // The rest of the file remains the same
        }

        // The rest of your script...
    </script>
</body>
</html>
